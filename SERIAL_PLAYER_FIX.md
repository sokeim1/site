# üé¨ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–õ–ï–ï–†–ê

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–µ—Ä–∏–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ò–≥—Ä–∞ –≤ –∫–∞–ª—å–º–∞—Ä–∞") –∑–∞–≥—Ä—É–∂–∞–ª—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç - –∫–∞–∫–æ–π-—Ç–æ —Ñ–∏–ª—å–º –≤–º–µ—Å—Ç–æ —Å–µ—Ä–∏–∞–ª–∞.

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `iframe_url` –∏–∑ API –Ω–∞–ø—Ä—è–º—É—é, –∫–æ—Ç–æ—Ä—ã–π –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: –û–¥–∏–Ω –ø–ª–µ–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å–º–æ–≤

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤ –∑–∞–≥—Ä—É–∂–∞–ª—Å—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–ª–µ–µ—Ä.

**–ü—Ä–∏—á–∏–Ω–∞:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ `iframe_url` –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∏–ª—å–º–∞, –∏ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –µ–≥–æ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL –Ω–∞ –æ—Å–Ω–æ–≤–µ ID —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å–º–∞.

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç kp_id –≤ –¥–∞–Ω–Ω—ã—Ö

–¢—Ä–µ—Ç—å—è –ø—Ä–æ–±–ª–µ–º–∞ - –æ–±—ä–µ–∫—Ç —Ñ–∏–ª—å–º–∞ –∏–∑ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª `kp_id`, —Ç–æ–ª—å–∫–æ `id`.

**–ü—Ä–∏—á–∏–Ω–∞:** API `/publisher/videos/links` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `kp_id`, –Ω–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ localStorage –∏–ª–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª–µ –º–æ–≥–ª–æ —Ç–µ—Ä—è—Ç—å—Å—è. –ù—É–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `id` –∫–∞–∫ fallback.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–≤–∞—Ç—å URL –Ω–∞ –æ—Å–Ω–æ–≤–µ ID (–§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï)

**–î–ª—è –í–°–ï–• —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤:**
- –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–µ—Ç—Å—è URL –Ω–∞ –æ—Å–Ω–æ–≤–µ `kp_id` –∏–ª–∏ `imdb_id`
- `iframe_url` –∏–∑ API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback (–µ—Å–ª–∏ –Ω–µ—Ç ID)
- –§–æ—Ä–º–∞—Ç: `https://vibix.org/embed/kp/{kp_id}`

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Vibix API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª) –ø–æ ID
- –î–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å–µ–∑–æ–Ω–æ–≤ –∏ —Å–µ—Ä–∏–π
- –î–ª—è —Ñ–∏–ª—å–º–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∞–º —Ñ–∏–ª—å–º
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö URL

### 2. –ù–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å iframe_url

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫—ç—à–µ–º:**
- –°—Ç–∞—Ä—ã–π –∫–æ–¥ –∫—ç—à–∏—Ä–æ–≤–∞–ª `iframe_url` –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥—Ä—É–≥–æ–≥–æ —Ñ–∏–ª—å–º–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π `iframe_url`
- –í—Å–µ —Ñ–∏–ª—å–º—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç–µ–Ω—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –£–¥–∞–ª—è–µ–º `iframe_url` –∏ `player_url` –ø–µ—Ä–µ–¥ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º URL –∑–∞–Ω–æ–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ ID —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å–º–∞

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å id –∫–∞–∫ fallback –¥–ª—è kp_id

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è URL:**
1. **kp_id** - –æ—Å–Ω–æ–≤–Ω–æ–π Kinopoisk ID
2. **id** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ kp_id (–≤ API Vibix —ç—Ç–æ —á–∞—Å—Ç–æ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ)
3. **imdb_id** - IMDB ID
4. **iframe_url** - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ID

### 4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### `setupPlayerButtons()` - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

```javascript
// –ü–†–ò–û–†–ò–¢–ï–¢ 1: kp_id (Kinopoisk ID)
if (movie.kp_id) {
    playerUrl = `https://vibix.org/embed/kp/${movie.kp_id}`;
}
// –ü–†–ò–û–†–ò–¢–ï–¢ 2: id (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ kp_id)
else if (movie.id) {
    playerUrl = `https://vibix.org/embed/kp/${movie.id}`;
    console.log('‚úÖ Created Vibix URL from id (as kp_id)');
}
// –ü–†–ò–û–†–ò–¢–ï–¢ 3: imdb_id
else if (movie.imdb_id) {
    playerUrl = `https://vibix.org/embed/imdb/${movie.imdb_id}`;
}
// Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º iframe_url —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç ID
else if (movie.iframe_url) {
    playerUrl = movie.iframe_url;
}
```

#### `loadDetailedDataInBackground()` - –ó–∞–ø—Ä–æ—Å—ã –∫ API

```javascript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º id –∫–∞–∫ fallback –¥–ª—è kp_id
const kpIdToUse = movie.kp_id || movie.id;
if (kpIdToUse) {
    promises.push(
        movieAPI.getMovieByKpId(kpIdToUse)
            .then(data => ({ source: 'kp_id', data }))
            .catch(() => null)
    );
}

// –î–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤ —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º id –∫–∞–∫ fallback
const serialKpId = movie.kp_id || movie.id;
if (movie.type === 'serial' && serialKpId) {
    promises.push(
        movieAPI.getSerialByKpId(serialKpId)
            .then(data => ({ source: 'serial', data }))
            .catch(() => null)
    );
}
```

#### `loadDetailedDataInBackground()` - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ iframe_url

```javascript
// –ù–ï –∫—ç—à–∏—Ä—É–µ–º iframe_url - –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Ñ–∏–ª—å–º–∞!
if (cachedData) {
    const cachedDataWithoutUrl = { ...cached.data };
    delete cachedDataWithoutUrl.iframe_url;
    delete cachedDataWithoutUrl.player_url;
    currentMovie = { ...currentMovie, ...cachedDataWithoutUrl };
}

// –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –∫—ç—à —Ç–æ–∂–µ —É–¥–∞–ª—è–µ–º URL
const dataToCache = { ...apiData };
delete dataToCache.iframe_url;
delete dataToCache.player_url;
sessionStorage.setItem(cacheKey, JSON.stringify({
    timestamp: Date.now(),
    data: dataToCache
}));
```

#### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞

```javascript
// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)
const cacheVersion = 'v2';
const currentVersion = localStorage.getItem('cache_version');
if (currentVersion !== cacheVersion) {
    console.log('üßπ Clearing old cache...');
    sessionStorage.clear();
    localStorage.setItem('cache_version', cacheVersion);
}
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–ª—è —Å–µ—Ä–∏–∞–ª–∞ "–ò–≥—Ä–∞ –≤ –∫–∞–ª—å–º–∞—Ä–∞":

1. **–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø:** `type === 'serial'`
2. **–ü–æ–ª—É—á–∞–µ–º ID:** `kp_id = 1236063` (–ö–∏–Ω–æ–ø–æ–∏—Å–∫ ID)
3. **–°–æ–∑–¥–∞–µ–º URL:** `https://vibix.org/embed/kp/1236063`
4. **–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–µ–µ—Ä:** Vibix –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∂–µ—Ç –≤—ã–±–æ—Ä —Å–µ–∑–æ–Ω–æ–≤ –∏ —Å–µ—Ä–∏–π

### –î–ª—è —Ñ–∏–ª—å–º–∞:

1. **–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø:** `type === 'movie'`
2. **–ò—Å–ø–æ–ª—å–∑—É–µ–º iframe_url:** –ï—Å–ª–∏ –µ—Å—Ç—å –≤ API
3. **–ò–ª–∏ —Å–æ–∑–¥–∞–µ–º URL:** `https://vibix.org/embed/kp/{kp_id}`
4. **–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–µ–µ—Ä:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ–∏–ª—å–º

## üìä –õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∞:**
```
üé¨ This is a SERIAL, creating player URL from ID...
‚úÖ Created Vibix URL for SERIAL from kp_id: https://vibix.org/embed/kp/1236063
üé¨ Final player URL: https://vibix.org/embed/kp/1236063
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è —Ñ–∏–ª—å–º–∞:**
```
‚úÖ Found iframe_url from API: https://vibix.org/embed/...
üé¨ Final player URL: https://vibix.org/embed/...
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –°–µ—Ä–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- ‚úÖ –§–∏–ª—å–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–±—ã—Å—Ç—Ä–æ)
- ‚úÖ –ü–ª–µ–µ—Ä Vibix –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å–µ–∑–æ–Ω–æ–≤/—Å–µ—Ä–∏–π –¥–ª—è —Å–µ—Ä–∏–∞–ª–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è —Ñ–∏–ª—å–º–æ–≤

## üîß –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `js/movie-details.js` - —Ñ—É–Ω–∫—Ü–∏–∏ `setupPlayerButtons()` –∏ `loadDetailedDataInBackground()`

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–µ—Ä–∏–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ —Å–µ–∑–æ–Ω–æ–≤ –∏ —Å–µ—Ä–∏–π.
