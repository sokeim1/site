# Настройка прокси-сервера для украинских пользователей

## Описание

Прокси-сервер автоматически определяет пользователей из Украины и проксирует изображения постеров фильмов через собственный сервер, чтобы обойти возможные блокировки.

## Установка и запуск

### 1. Установка зависимостей

```bash
npm install
```

### 2. Запуск прокси-сервера

```bash
# Продакшн режим
npm start

# Режим разработки (с автоперезапуском)
npm run dev
```

Сервер запустится на порту 3001.

### 3. Проверка работы

Откройте в браузере: http://localhost:3001/status

Вы увидите информацию о вашем IP и статусе прокси:

```json
{
  "status": "OK",
  "ip": "your.ip.address",
  "country": "UA",
  "useProxy": true,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## Как это работает

1. **Определение местоположения**: Сервер использует библиотеку `geoip-lite` для определения страны по IP-адресу
2. **Автоматическое проксирование**: Если пользователь из Украины, изображения загружаются через прокси
3. **Прозрачность**: Для пользователей из других стран изображения загружаются напрямую

## Эндпоинты

### GET /status
Проверка статуса прокси и определение местоположения пользователя.

**Ответ:**
```json
{
  "status": "OK",
  "ip": "192.168.1.1",
  "country": "UA",
  "useProxy": true,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### GET /proxy-image?url=<IMAGE_URL>
Проксирование изображений для украинских пользователей.

**Параметры:**
- `url` - URL изображения для проксирования

**Пример:**
```
http://localhost:3001/proxy-image?url=https://avatars.mds.yandex.net/get-kinopoisk-image/1600647/poster.jpg
```

## Интеграция с фронтендом

Фронтенд автоматически проверяет доступность прокси-сервера при загрузке страницы:

```javascript
// Проверка статуса прокси
async function checkProxyStatus() {
    try {
        const response = await fetch('http://localhost:3001/status');
        const data = await response.json();
        
        if (data.useProxy) {
            // Использовать прокси для изображений
            useProxy = true;
        }
    } catch (error) {
        // Прокси недоступен, использовать прямые ссылки
        useProxy = false;
    }
}
```

## Зависимости

- **express**: Веб-фреймворк для Node.js
- **cors**: Middleware для обработки CORS
- **node-fetch**: HTTP клиент для Node.js
- **geoip-lite**: Библиотека для определения местоположения по IP

## Безопасность

- Прокси работает только для изображений
- Проверяется тип контента
- Установлены таймауты для запросов
- Добавлены соответствующие заголовки безопасности

## Устранение неполадок

### Прокси-сервер не запускается
1. Убедитесь, что Node.js установлен (версия 14+)
2. Запустите `npm install` для установки зависимостей
3. Проверьте, что порт 3001 свободен

### Изображения не загружаются
1. Проверьте, что прокси-сервер запущен
2. Откройте консоль браузера для проверки ошибок
3. Убедитесь, что URL изображения корректный

### Прокси не активируется для украинских пользователей
1. Проверьте статус через `/status` эндпоинт
2. Убедитесь, что IP-адрес определяется корректно
3. Для тестирования можно временно изменить условие в коде

## Развертывание

Для развертывания на сервере:

1. Установите зависимости: `npm install --production`
2. Запустите сервер: `npm start`
3. Настройте процесс-менеджер (например, PM2):
   ```bash
   npm install -g pm2
   pm2 start proxy-server.js --name "movie-proxy"
   pm2 startup
   pm2 save
   ```

## Мониторинг

Прокси-сервер логирует все запросы в консоль. Для продакшена рекомендуется настроить логирование в файлы.

---

**Автор**: sokeim
**Версия**: 1.0.0
